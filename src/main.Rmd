---
title: "My first kernel for the Titanic sinking competition"
author: "Stefano Galeano"
date: "19 dicembre 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This is my first kernel.

## Getting data

The train/test datasets are loaded in R:

```{r}
train <- read.csv('../input/train.csv', header = TRUE, stringsAsFactors = FALSE, na.strings = c(""))
train$Set = "train"
test <- read.csv('../input/test.csv', header = TRUE,stringsAsFactors = FALSE, na.strings = c(""))
test$Set = "test"

# In order to streamline the process, the train and test datasets are binded
test$Survived <- NA # this is needed in order make possible the binding
full <- rbind(train,test)
```

## Cleaning Data

The following features need to be coerced into factor variable:

```{r}
# Feature coercing
full$Survived <- as.factor(full$Survived)
full$Sex <- as.factor(full$Sex)
full$Embarked <- as.factor(full$Embarked)
full$Pclass <- as.factor(full$Pclass)
```

### Missing value analysis:

Let's first have a look at the percentage of missing value for each feature:

```{r}
library(dplyr)
library(ggplot2)

missingValue <- sapply(full, function(feature){
        sum(is.na(feature))/length(feature)
}) 
missingValue = data.frame(missingValuePercentage = missingValue, feature = names(missingValue))

g <- ggplot(data = filter(missingValue,feature!="Survived" & missingValuePercentage != 0), 
            aes(reorder(feature, missingValuePercentage),missingValuePercentage))
g <- g + geom_bar(stat = "identity", fill="red")
g <- g + labs(title = "Missing values ranking [%]", x = "Feature", y = "Missing Values [%]")
g <- g + coord_flip() + theme_bw()
g
```

#### Extracting the title from the the Name feature 

From the `Name` feature is possible to extract the title. The idea is to use the feature in order to:
+ better understand the family status (married or maiden)
+ is part of the crew
+ help us to handle the NA for the `Age` feature

Each `Name` is of the form `String, Title. String`, and using regex we can extract the Title part:

```{r}
head(full$Name)
full$Name.title <- gsub(pattern = "([\\w|\\-| |']*), ([\\w| ]*\\.) (.*)", x=full$Name, replacement="\\2", ignore.case=TRUE, perl = TRUE)
```

Let's have a look at the titles and their frequency:

```{r}
table(full$Name.title)
```

Since we want to avoid overfitting, the less frequent titles are pooled in the more common ones:

```{r}
full <- full %>% mutate(
        Title = case_when(
                # Young boy less then 18 years old
                Name.title == "Master."                 ~ "Master",

                # Girl or unmarried women
                Name.title == "Miss." | 
                Name.title == "Mlle."                   ~ "Miss",
                
                # Women married
                Name.title == "Mrs."  | 
                Name.title == "Mme."  |
                Name.title == "Dona."                   ~ "Mrs",

                # Women with unspecified status
                Name.title == "Ms."           |
                Name.title == "Lady."         |
                Name.title == "the Countess." |
                Name.title == "Dr." & Sex == "female"   ~ "Mrs", # In this group because there are too few observation
                
                # Men
                Name.title == "Mr."       |
                Name.title == "Sir."      |
                Name.title == "Rev."      |
                Name.title == "Don."      |
                Name.title == "Jonkheer." |            
                Name.title == "Dr." & Sex == "male"     ~ "Mr",
                
                # Crew
                Name.title == "Capt." |
                Name.title == "Col."  |
                Name.title == "Major."                          ~ "Officer"
                )
)


full$Title <- as.factor(full$Title)
```

Below it's shown the new histogram of the `Title` feature just created
```{r}
g <- ggplot(full, aes(full$Title))
g <- g + geom_bar(color="red", fill="blue")
g <- g + coord_flip() + labs(title = "Passenger titles", x = "Title", y = "Count") + theme_bw()
g
```

# Extracting the ticket number from the Ticked feature

Using the same approch used for the Title (checking the form and using regex), the `Ticket.number` is extracted: 

```{r}
# full$Ticket.initials <- gsub(pattern = "^((.*) )?(\\d*)?$", x=full$Ticket, replacement="\\2")
# full$Ticket.initials <- as.factor(full$Ticket.initials)
full$Ticket.number <- gsub(pattern = "^((.*) )?(\\d*)?$", x=full$Ticket, replacement="\\3")
full$Ticket.number <- gsub(pattern = "^LINE$", x=full$Ticket.number, replacement="0")
full$Ticket.number <- as.integer(full$Ticket.number)
```

### Missing Value imputation

#### Age feature

By looking at the `Age` distribution for each `Title`:

```{r}
g <- ggplot(data = full, aes(Age))
g <- g + geom_bar(binwidth = 1)
g <- g + labs(title = "Age distribution for each Title", x = "Age", y = "Count") + theme_bw()
g + facet_grid(Title~., scales = "free")
```

it seems reasonable to use the median `Age` in the `Title` group of appartenency.

```{r}
full <- full %>% group_by(Title) %>% mutate(Age.mdn = median(Age,na.rm = TRUE))

full <- full %>% mutate(
        Age = if_else(is.na(Age),
                      Age.mdn,
                      Age
                      )
)
```

#### Embarked feature

In order to impute the Embarked feature we get help from the `Ticket.number` distribution in each `Embarked` group: 

```{r}
full[is.na(full$Embarked),]

g <- ggplot(data = full, aes(Embarked,Ticket.number))
g <- g + geom_boxplot() + ylim(0, 400000)
g <- g + theme_bw() + labs(title = "Ticket number distribution for each Embarked", x = "Embarked", y = "Ticket.number")
# legend
g
```

```{r}
full$Embarked <- as.factor(if_else(is.na(full$Embarked),"S",as.character(full$Embarked)))
```

#### Cabin feature

Since the high number of missing value for the `Cabin` feature we're going to remove it:

```{r}
full$Cabin <- NULL
```

## Feature engineering

### Family size

The question that motivates the creation of the Family size feature is:

+ Does the big families have more chance to survive than the lonesome travelers?

The `Family.count` feature is generated by summing up the `sibsp` (# of siblings/spouses aboard) and the `parch` (# of parent/children aboard) features:

```{r}
full$Family.count <- full$Parch + full$SibSp

g <- ggplot(data = full[!is.na(full$Survived),], aes(Family.count, fill = Survived))
g <- g + geom_bar(position = "dodge")
g <- g + scale_x_continuous(breaks =  0:10)
g <- g + labs(title = "Survival count wrt Family.count", x = "Family.count", y = "count")
g
```

From the histogram it appears that the lonsome travelers and big families have a prevalence of dead respect to medium size families. So, the `Family.size` variable is generated 

```{r}
full <- full %>% mutate(Family.size = cut(Family.count, breaks = c(0,1,4,11), labels = c("small","medium","big"), right = FALSE))
```


## Exploratory analysis

The train is partioned in train and test dataset in order to avoid overfitting and calculate an out-of-sample estimation error in the end:

```{r}
train <- full[full$Set == "train",]
test <- full[full$Set == "test",]
train$Set <- NULL
test$Set <- NULL
```

After doing some feature selection, the following features are removed for the model:

```{r}
train$SibSp <- NULL
train$Parch <- NULL
train$Family.count <- NULL
train$Name <- NULL
train$Name.surname <- NULL
train$Name.title <- NULL
train$Cabin <- NULL
train$Cabin.room <- NULL
train$Ticket <- NULL
train$Fare <- NULL
train$Age.mdn <- NULL
train$Ticket.number <- NULL
train$Ticket.initials <- NULL
train$PassengerId <- NULL
```

## Model training

```{r, message=FALSE}
library(caret)

set.seed(4974)
inTrain <- createDataPartition(train$Survived,p=.75,list = FALSE)

train.train <- train[inTrain,]
train.test <- train[-inTrain,]
str(train.train$Title)
str(train.test$Title)
df <- train.train
```

The Model is then trained using *k-fold* cross validation in order to avoid overfitting:

```{r}
set.seed(72034)

ctrl <- trainControl(method = "cv") # cross validation using 10-fold method
model <- train(Survived~.,data = df,method="rf", trControl = ctrl)
predicted <- predict(model)

confusionMatrix(predicted,df$Survived)
```

The model is used to predict the outcome in the test dataset in order to estimate the out of sample error:

```{r, warning=FALSE}
df = train.test

set.seed(5102)

predicted <- predict(model,df)
confusionMatrix(predicted,df$Survived)
```

## Conclusion

Finaly the model is used to predict the output in the test dataset:

```{r,warning=FALSE}
df = test
        
set.seed(5102)

predicted <- predict(model,df)
write.csv(data.frame(PassengerId = test$PassengerId,Survived = predicted),"solution.csv",row.names = FALSE)
```

