---
title: "Titanic sinking"
author: "Stefano Galeano"
date: "19 dicembre 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

## Getting and cleaning data

The train/test datasetsa are loaded, treating whitespaces as NA, and coercing the opportune features into factors:

```{r}
train <- read.csv('train.csv', header = TRUE, stringsAsFactors = FALSE, na.strings = c(""))
train$Survived <- as.factor(train$Survived)
train$Sex <- as.factor(train$Sex)
train$Embarked <- as.factor(train$Embarked)

test <- read.csv('test.csv', header = TRUE,stringsAsFactors = FALSE, na.strings = c(""))
test$Sex <- as.factor(test$Sex)
test$Embarked <- as.factor(test$Embarked)
```

The `ticket` feature is splitted in two: 

```{r}
train$Ticket.initials <- gsub(pattern = "^((.*) )?(\\d*)?$", x=train$Ticket, replacement="\\2")
train$Ticket.initials <- as.factor(train$Ticket.initial)
train$Ticket.number <- gsub(pattern = "^((.*) )?(\\d*)?$", x=train$Ticket, replacement="\\3")
train$Ticket.number <- gsub(pattern = "^LINE$", x=train$Ticket.number, replacement="0")
train$Ticket.number <- as.integer(train$Ticket.number)

test$Ticket.initials <- gsub(pattern = "^((.*) )?(\\d*)?$", x=test$Ticket, replacement="\\2")
test$Ticket.initials <- as.factor(test$Ticket.initial)
test$Ticket.number <- gsub(pattern = "^((.*) )?(\\d*)?$", x=test$Ticket, replacement="\\3")
test$Ticket.number <- gsub(pattern = "^LINE$", x=test$Ticket.number, replacement="0")
test$Ticket.number <- as.integer(test$Ticket.number)
```

The `Title` is estracted from the `Name` feature:

```{r}
train$Name.surname <- gsub(pattern = "([\\w|\\-| |']*), ([\\w| ]*\\.) (.*)", x=train$Name, replacement="\\1", ignore.case=TRUE, perl = TRUE)
train$Name.title <- gsub(pattern = "([\\w|\\-| |']*), ([\\w| ]*\\.) (.*)", x=train$Name, replacement="\\2", ignore.case=TRUE, perl = TRUE)
train$Name.title <- as.factor(train$Name.title)

test$Name.surname <- gsub(pattern = "([\\w|\\-| |']*), ([\\w| ]*\\.) (.*)", x=test$Name, replacement="\\1", ignore.case=TRUE, perl = TRUE)
test$Name.title <- gsub(pattern = "([\\w|\\-| |']*), ([\\w| ]*\\.) (.*)", x=test$Name, replacement="\\2", ignore.case=TRUE, perl = TRUE)
test$Name.title <- as.factor(test$Name.title)

# used in order to avoid error when predicting in the test dataset
levels(train$Name.title) <- union(levels(train$Name.title),levels(test$Name.title))
```

The `Cabin` feature is splitted in two:

```{r}
train$Cabin[is.na(train$Cabin)] <- "U" # Unknown
train$Cabin.deck <- gsub(pattern = "^(\\D)(\\d{0,3}).*$", x=train$Cabin, replacement="\\1", ignore.case=TRUE, perl = TRUE)
train$Cabin.deck <- as.factor(train$Cabin.deck)
train$Cabin.room <- gsub(pattern = "^(\\D)(\\d{0,3}).*$", x=train$Cabin, replacement="\\2", ignore.case=TRUE, perl = TRUE)

test$Cabin[is.na(test$Cabin)] <- "U" # Unknown
test$Cabin.deck <- gsub(pattern = "^(\\D)(\\d{0,3}).*$", x=test$Cabin, replacement="\\1", ignore.case=TRUE, perl = TRUE)
test$Cabin.deck <- as.factor(test$Cabin.deck)
test$Cabin.room <- gsub(pattern = "^(\\D)(\\d{0,3}).*$", x=test$Cabin, replacement="\\2", ignore.case=TRUE, perl = TRUE)
```

After doing some feature selection, the following one are removed for the analysis:

```{r}
train$Name <- NULL
train$Name.surname <- NULL
train$Cabin <- NULL
train$Cabin.room <- NULL
train$Ticket <- NULL
train$Fare <- NULL
train$Ticket.number <- NULL
train$Ticket.initials <- NULL
train$PassengerId <- NULL

test$Name <- NULL
test$Name.surname <- NULL
test$Cabin <- NULL
test$Cabin. <- NULL
test$Ticket <- NULL
test$Fare <- NULL
test$Ticket.number <- NULL
test$Ticket.initials <- NULL
```

# Exploratory analysis

The train is partioned in train and test dataset in order to avoid overfitting and calculate an out-of-sample estimation error in the end:

```{r, message=FALSE}
library(caret)

set.seed(4974)
inTrain <- createDataPartition(train$Survived,p=.75,list = FALSE)

train.train <- train[inTrain,]
train.test <- train[-inTrain,]
df <- train.train
```

Below, it's plotted a map for the missing value: 

```{r, message=FALSE}
library(Amelia)
missmap(df, col=c('grey', 'steelblue'), y.cex=0.5, x.cex=0.8)
```

The messing value are imputed using the `mice` method:

```{r}
library(mice)
set.seed(5102)
imp.df <- mice(df, method='rf', printFlag=FALSE)
df <- complete(imp.df)
# missmap(df, col=c('grey', 'steelblue'), y.cex=0.5, x.cex=0.8)
```

The Model is then trained using *k-fold* cross validation in order to avoid overfitting:

```{r}
set.seed(72034)

ctrl <- trainControl(method = "cv") # cross validation using 10-fold method
model <- train(Survived~.,data = df,method="bayesglm", trControl = ctrl)
predicted <- predict(model)

confusionMatrix(predicted,df$Survived)
```

The model is used to predict the outcome in the test dataset in order to estimate the out of sample error:

```{r, warning=FALSE}
df = train.test

set.seed(5102)

# imputing NA using the same method used for the training set
imp.df <- mice(df, method='rf', printFlag=FALSE)
df <- complete(imp.df)
predicted <- predict(model,df)

confusionMatrix(predicted,df$Survived)
```

Finaly the model is used to predict the output in the test dataset:

```{r,warning=FALSE}
df = test
        
set.seed(5102)

# imputing NA using the same method used for the training set
imp.df <- mice(df, method='rf', printFlag=FALSE)
df <- complete(imp.df)

predicted <- predict(model,df)
write.csv(data.frame(PassengerId = test$PassengerId,Survived = predicted),"solution.csv",row.names = FALSE)
```

