---
title: "My first kernel for the Titanic sinking competition"
author: "Stefano Galeano"
date: "19 dicembre 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This is my first kernel.

## Getting data

The train/test datasetsa are loaded, treating whitespaces as NA and coercing the opportune features into factors:

```{r}
train <- read.csv('train.csv', header = TRUE, stringsAsFactors = FALSE, na.strings = c(""))
train$Set = "train"
test <- read.csv('test.csv', header = TRUE,stringsAsFactors = FALSE, na.strings = c(""))
test$Set = "test"
```

## Cleaning Data

In order to streamline the process, we're going to merge the train and test datasets, we'll therfore to add add the `Survived` variable in the test dataset:

```{r}
test$Survived <- NA
full <- rbind(train,test)
```

```{r}
# Feature coercing
full$Survived <- as.factor(full$Survived)
full$Sex <- as.factor(full$Sex)
full$Embarked <- as.factor(full$Embarked)
```

Missing value analysis:

```{r}
library(dplyr)
library(ggplot2)

missingValue <- sapply(full, function(feature){
        sum(is.na(feature))/length(feature)
}) 
missingValue = data.frame(missingValuePercentage = missingValue, feature = names(missingValue))

g <- ggplot(data = filter(missingValue,feature!="Survived" & missingValuePercentage != 0), 
            aes(reorder(feature, missingValuePercentage),missingValuePercentage))
g <- g + geom_bar(stat = "identity", fill="red")
g <- g + coord_flip() + labs("Missing values ranking [%]", "Feature", "Missing Values [%]") + theme_bw()
g
```

## Data manipulation

### Feature enginnering 1: The title 

Each `Name` contains the title which is rappresentative of the family status, and also allow us to discrimanate between the crew and the others:

```{r}
full$Name.title <- gsub(pattern = "([\\w|\\-| |']*), ([\\w| ]*\\.) (.*)", x=full$Name, replacement="\\2", ignore.case=TRUE, perl = TRUE)
table(full$Name.title)
```

Since we want to avoid overfitting, the less frequent titles are pooled in more common ones:

```{r}
full <- full %>% mutate(
        Title = case_when(
                # Young boy less then 18 years old
                Name.title == "Master."                         ~ "Master",

                # Girl or unmarried women
                Name.title == "Miss." | 
                Name.title == "Mlle."                           ~ "Miss",
                
                # Women married
                Name.title == "Mrs."  | 
                Name.title == "Mme."  |
                Name.title == "Dona."                           ~ "Mrs",

                # Women with unspecified status
                Name.title == "Ms."           |
                Name.title == "Lady."         |
                Name.title == "the Countess." |
                Name.title == "Dr." & Sex == "female"           ~ "Mrs", # In this group because there are too few observation
                
                # Men
                Name.title == "Mr."       |
                Name.title == "Sir."      |
                Name.title == "Rev."      |
                Name.title == "Don."      |
                Name.title == "Jonkheer." |            
                Name.title == "Dr." & Sex == "male"             ~ "Mr",
                
                # Crew
                Name.title == "Capt." |
                Name.title == "Col."  |
                Name.title == "Major."                          ~ "Officer"
                )
)


full$Title <- as.factor(full$Title)

g <- ggplot(full, aes(full$Title))
g <- g + geom_bar(color="red", fill="blue")
g <- g + coord_flip() + labs("Passenger titles", "Title", "Count") + theme_bw()
g
```

### Missing Value imputation

#### Age feature

Let's have a look at the distributions for each `Title`:

```{r}
g <- ggplot(data = full, aes(Age))
g <- g + geom_bar(binwidth = 1)
g <- g + labs("Missing values ranking [%]", "Feature", "Missing Values [%]") + theme_bw()
g + facet_grid(Title~., scales = "free")
```

Since the result obtained with the last plot, it seems reasonable to use the median in the `Title` group of appartenency for the `Age`:

```{r}
full <- full %>% group_by(Title) %>% mutate(Age.mdn = median(Age,na.rm = TRUE))

full <- full %>% mutate(
        Age = if_else(is.na(Age),
                      Age.mdn,
                      Age
                      )
)
```


#### Embarked feature

The `ticket` feature is splitted in two: 

```{r}
full$Ticket.initials <- gsub(pattern = "^((.*) )?(\\d*)?$", x=full$Ticket, replacement="\\2")
full$Ticket.initials <- as.factor(full$Ticket.initials)
full$Ticket.number <- gsub(pattern = "^((.*) )?(\\d*)?$", x=full$Ticket, replacement="\\3")
full$Ticket.number <- gsub(pattern = "^LINE$", x=full$Ticket.number, replacement="0")
full$Ticket.number <- as.integer(full$Ticket.number)
```

```{r}
full[is.na(full$Embarked),]

g <- ggplot(data = full, aes(Embarked,Ticket.number))
g <- g + geom_boxplot() + ylim(0, 400000)
g <- g + labs("", "", "") + theme_bw()
g
```

```{r}
full$Embarked <- as.factor(if_else(is.na(full$Embarked),"S",as.character(full$Embarked)))
```

#### Cabin feature

Since the high number of missing value for the `Cabin` feature we're going to remove it:

```{r}
# full$Cabin[is.na(full$Cabin)] <- "U" # Unknown
# full$Cabin.deck <- gsub(pattern = "^(\\D)(\\d{0,3}).*$", x=full$Cabin, replacement="\\1", ignore.case=TRUE, perl = TRUE)
# full$Cabin.deck <- as.factor(full$Cabin.deck)
# full$Cabin.room <- gsub(pattern = "^(\\D)(\\d{0,3}).*$", x=full$Cabin, replacement="\\2", ignore.case=TRUE, perl = TRUE)
full$Cabin <- NULL
```


## Feature engineering


```{r}
full$Family.count <- full$Parch + full$SibSp
g <- ggplot(data = full[!is.na(full$Survived),], aes(Family.count, fill = Survived))
g <- g + geom_histogram(position = "stack",binwidth = 1)
g
```


```{r}
full <- full %>% mutate(
        Family.size = case_when(
                Family.count == 0                   ~ "alone",
                Family.count > 0 & Family.count < 4 ~ "medium",
                Family.count > 3                    ~ "big"
                )
        )
full$Family.size <- as.factor(full$Family.size)
```



# Exploratory analysis

The train is partioned in train and test dataset in order to avoid overfitting and calculate an out-of-sample estimation error in the end:

```{r}
train <- full[full$Set == "train",]
test <- full[full$Set == "test",]
train$Set <- NULL
test$Set <- NULL
```


After doing some feature selection, the following one are removed for the analysis:

```{r}
train$SibSp <- NULL
train$Parch <- NULL
train$Family.count <- NULL
train$Name <- NULL
train$Name.surname <- NULL
train$Name.title <- NULL
train$Cabin <- NULL
train$Cabin.room <- NULL
train$Ticket <- NULL
train$Fare <- NULL
train$Age.mdn <- NULL
train$Ticket.number <- NULL
train$Ticket.initials <- NULL
train$PassengerId <- NULL
```

```{r, message=FALSE}
library(caret)

set.seed(4974)
inTrain <- createDataPartition(train$Survived,p=.75,list = FALSE)

train.train <- train[inTrain,]
train.test <- train[-inTrain,]
str(train.train$Title)
str(train.test$Title)
df <- train.train
```

The Model is then trained using *k-fold* cross validation in order to avoid overfitting:

```{r}
set.seed(72034)

ctrl <- trainControl(method = "cv") # cross validation using 10-fold method
model <- train(Survived~.,data = df,method="rf", trControl = ctrl)
predicted <- predict(model)

confusionMatrix(predicted,df$Survived)
```

The model is used to predict the outcome in the test dataset in order to estimate the out of sample error:

```{r, warning=FALSE}
df = train.test

set.seed(5102)

predicted <- predict(model,df)
confusionMatrix(predicted,df$Survived)
```

Finaly the model is used to predict the output in the test dataset:

```{r,warning=FALSE}
df = test
        
set.seed(5102)

predicted <- predict(model,df)
write.csv(data.frame(PassengerId = test$PassengerId,Survived = predicted),"solution.csv",row.names = FALSE)
```

